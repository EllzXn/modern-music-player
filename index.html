<!DOCTYPE html>
<html lang="id" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ZTune - Immersive Player</title>

    <link rel="shortcut icon" href="https://files.catbox.moe/s248au.jpg" type="image/x-icon"/>
    <script src="https://cdn.tailwindcss.com"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        background: '#050505', 
                        surface: '#121212',
                        surfaceHighlight: '#27272a',
                        primary: { 500: '#8b5cf6', 600: '#7c3aed' }
                    },
                    fontFamily: {
                        sans: ['Plus Jakarta Sans', 'sans-serif'],
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.5s ease-out forwards',
                        'slide-down': 'slideDown 0.3s ease-out forwards',
                        'slide-up': 'slideUp 0.3s ease-out forwards',
                        'blob': 'blob 15s infinite',
                    },
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                        slideDown: { '0%': { opacity: '0', transform: 'translateY(-20px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } },
                        slideUp: { '0%': { transform: 'translateY(100%)' }, '100%': { transform: 'translateY(0)' } },
                        blob: {
                            '0%': { transform: 'translate(0px, 0px) scale(1)' },
                            '33%': { transform: 'translate(30px, -50px) scale(1.1)' },
                            '66%': { transform: 'translate(-20px, 20px) scale(0.9)' },
                            '100%': { transform: 'translate(0px, 0px) scale(1)' },
                        }
                    }
                }
            }
        }
    </script>

    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; -webkit-tap-highlight-color: transparent; }
        * { scrollbar-width: thin; scrollbar-color: rgba(255,255,255,0.1) transparent; }
        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-thumb { background: transparent; border-radius: 10px; }
        *:hover::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); }
        input[type=range] { -webkit-appearance: none; background: transparent; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 12px; width: 12px; border-radius: 50%; background: #fff; margin-top: -4px; cursor: pointer; }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; cursor: pointer; background: #3f3f46; border-radius: 9999px; }
        .marquee-container { overflow: hidden; white-space: nowrap; position: relative; mask-image: linear-gradient(to right, transparent, black 5%, black 95%, transparent); }
        .marquee-content { display: inline-block; min-width: 100%; }
        .animate-scroll { animation: scroll-left 12s linear infinite; }
        @keyframes scroll-left { 0%, 15% { transform: translateX(0); } 85%, 100% { transform: translateX(-100%); } }
        .ambient-glow { position: fixed; width: 600px; height: 600px; background: radial-gradient(circle, rgba(139, 92, 246, 0.15) 0%, rgba(0,0,0,0) 70%); border-radius: 50%; pointer-events: none; z-index: 0; animation: blob 15s infinite ease-in-out; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="bg-background text-white h-screen w-full overflow-hidden flex flex-col relative selection:bg-primary-500 selection:text-white">

    <div class="ambient-glow top-[-20%] left-[-10%] opacity-40"></div>
    <div class="ambient-glow bottom-[-20%] right-[-10%] bg-[radial-gradient(circle,rgba(56,189,248,0.1)_0%,rgba(0,0,0,0)_70%)] animation-delay-2000"></div>

    <header id="main-header" class="w-full px-6 py-5 flex justify-between items-center z-40 sticky top-0">
        <div class="flex items-center gap-2">
            <div class="w-3 h-3 rounded-full bg-[#ff5f57] shadow-[0_0_10px_rgba(255,95,87,0.3)]"></div>
            <div class="w-3 h-3 rounded-full bg-[#febc2e] shadow-[0_0_10px_rgba(254,188,46,0.3)]"></div>
            <div class="w-3 h-3 rounded-full bg-[#28c840] shadow-[0_0_10px_rgba(40,200,64,0.3)]"></div>
        </div>
        
        <div class="absolute left-1/2 transform -translate-x-1/2 flex bg-white/5 rounded-full p-1 backdrop-blur-sm border border-white/5">
            <button id="tab-search" class="px-4 py-1.5 text-xs font-bold rounded-full bg-white text-black transition-all shadow-lg">Search</button>
            <button id="tab-library" class="px-4 py-1.5 text-xs font-bold rounded-full text-gray-400 hover:text-white transition-all">Library</button>
        </div>

        <button id="search-toggle-btn" class="p-2 rounded-full text-gray-400 hover:text-white hover:bg-white/10 transition-all focus:outline-none">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
        </button>
    </header>

    <main class="flex-1 w-full max-w-6xl mx-auto flex flex-col relative z-10 overflow-hidden px-4 md:px-6 pb-20">
        
        <div id="search-container" class="hidden w-full py-4 animate-slide-down shrink-0 transition-all">
            <form id="search-form" class="relative group w-full">
                <input type="text" id="search-input" placeholder="Search songs or artists..." 
                    class="w-full pl-12 pr-4 py-4 bg-surface/80 backdrop-blur-md border border-white/10 focus:border-primary-500 rounded-2xl text-base text-white placeholder-gray-500 focus:outline-none focus:ring-1 focus:ring-primary-500 transition-all shadow-lg" autocomplete="off">
                <div class="absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-500">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                </div>
            </form>
        </div>

        <div id="content-area" class="flex-1 overflow-y-auto mt-2 px-1 relative">

            <div id="greeting-container" class="mt-8 mb-8 text-center animate-fade-in flex flex-col justify-center h-[50vh]">
                <span class="text-primary-500 text-xs font-bold tracking-[0.3em] uppercase mb-4 animate-pulse">Ready to Listen?</span>
                <h2 id="greeting-text" class="text-4xl md:text-6xl font-extrabold text-white mb-4 tracking-tight">Music Awaits.</h2>
                <p class="text-gray-500 text-sm md:text-base font-light max-w-md mx-auto">Gunakan tab di atas untuk mencari atau melihat koleksi lagumu.</p>
            </div>

            <div id="message-area" class="text-center text-sm font-medium text-gray-400 py-4 transition-all hidden"></div>

            <div id="results-area" class="hidden grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 pb-24 animate-fade-in"></div>
            
            <div id="library-area" class="hidden pb-24 animate-fade-in">
                <div class="flex items-center justify-between mb-6 px-2">
                    <h3 class="text-xl font-bold text-white">Your Liked Songs</h3>
                    <span id="library-count" class="text-xs text-gray-500 font-mono">0 songs</span>
                </div>
                
                <div id="library-list" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                    </div>
                
                <div id="empty-library-msg" class="hidden flex flex-col items-center justify-center mt-20 text-center">
                    <div class="w-16 h-16 rounded-full bg-white/5 flex items-center justify-center mb-4 text-gray-500">
                        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path></svg>
                    </div>
                    <p class="text-gray-400">Belum ada lagu yang disukai.</p>
                </div>
            </div>

        </div>
    </main>

    <div id="mini-player" class="fixed bottom-4 left-4 right-4 z-50 bg-[#1e1e21]/90 backdrop-blur-xl border border-white/10 rounded-2xl p-3 flex items-center justify-between shadow-2xl transform translate-y-[150%] transition-transform duration-300 cursor-pointer hidden">
        <div class="flex items-center gap-3 overflow-hidden flex-1">
            <div class="w-10 h-10 rounded-full overflow-hidden bg-gray-800 shrink-0 animate-[spin_10s_linear_infinite]">
                <img id="mini-cover" src="" class="w-full h-full object-cover">
            </div>
            <div class="flex flex-col overflow-hidden w-full pr-4">
                <h4 id="mini-title" class="text-sm font-bold text-white truncate">Title</h4>
                <p id="mini-artist" class="text-xs text-gray-400 truncate">Artist</p>
            </div>
        </div>
        <div class="flex items-center gap-4 pr-2">
            <button id="mini-like-btn" class="text-gray-400 hover:text-red-500 transition-colors focus:outline-none">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
            </button>
            <button id="mini-play-btn" class="text-white hover:text-primary-400 focus:outline-none p-1">
                <svg id="mini-play-icon" class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
                <svg id="mini-pause-icon" class="w-6 h-6 hidden" fill="currentColor" viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>
            </button>
        </div>
    </div>

    <div id="player-overlay" class="fixed inset-0 z-[60] bg-[#050505] hidden flex-col transition-all duration-500">

        <div class="absolute inset-0 z-0 overflow-hidden opacity-30 pointer-events-none">
            <img id="player-bg-image" src="" class="w-full h-full object-cover blur-3xl scale-125">
            <div class="absolute inset-0 bg-gradient-to-b from-[#050505] via-transparent to-[#050505]"></div>
        </div>

        <div class="relative z-10 w-full px-6 py-6 flex justify-between items-center">
            <button id="close-player-btn" class="p-2 rounded-full bg-white/5 hover:bg-white/10 border border-white/5 transition-all group">
                <svg class="w-6 h-6 text-gray-300 group-hover:text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
            </button>
            <span class="text-xs font-bold tracking-widest uppercase text-gray-500">Now Playing</span>
            
            <button id="full-like-btn" class="p-2 rounded-full hover:bg-white/10 transition-all text-gray-400">
                <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
            </button>
        </div>

        <div class="relative z-10 flex-1 flex flex-col items-center justify-center w-full max-w-5xl mx-auto px-6 pb-12">

            <div class="flex flex-col md:flex-row items-center w-full gap-8 md:gap-16">

                <div class="w-full md:w-1/2 flex justify-center">
                    <div class="relative w-[70vw] h-[70vw] max-w-[320px] max-h-[320px] md:w-[400px] md:h-[400px] group">
                        <div class="absolute inset-0 bg-primary-500 blur-[50px] opacity-20 group-hover:opacity-40 transition-opacity duration-1000"></div>
                        <img id="player-cover" src="" class="relative w-full h-full object-cover rounded-[2rem] shadow-2xl border border-white/10 z-10 transform transition-transform duration-700 hover:scale-[1.02]">
                    </div>
                </div>

                <div class="w-full md:w-1/2 flex flex-col justify-center mt-6 md:mt-0">

                    <div class="text-center md:text-left mb-8 overflow-hidden w-full">
                        <div id="marquee-wrapper" class="marquee-container w-full">
                            <h2 id="player-title" class="text-2xl md:text-4xl font-bold text-white leading-tight mb-2 marquee-content w-max">Song Title</h2>
                        </div>
                        <p id="player-artist" class="text-lg text-gray-400 font-medium truncate">Artist Name</p>
                    </div>

                    <div class="w-full mb-8 group">
                        <div class="relative cursor-pointer h-4 flex items-center" id="progress-container">
                            <div class="w-full h-1 bg-white/10 rounded-full overflow-hidden group-hover:h-1.5 transition-all">
                                <div id="progress-fill" class="h-full bg-white w-0 rounded-full relative shadow-[0_0_15px_rgba(255,255,255,0.5)]"></div>
                            </div>
                        </div>
                        <div class="flex justify-between mt-2 text-xs font-mono text-gray-500">
                            <span id="current-time">0:00</span>
                            <span id="duration">0:00</span>
                        </div>
                    </div>

                    <div class="flex items-center justify-center md:justify-start gap-8 mb-10">
                        <button id="loop-btn" class="text-gray-500 hover:text-white transition-colors relative">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                            <div id="loop-dot" class="absolute -top-1 -right-1 w-1.5 h-1.5 bg-primary-500 rounded-full hidden"></div>
                        </button>

                        <button id="prev-btn" class="text-gray-400 hover:text-white transition-colors">
                             <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 24 24"><path d="M6 6h2v12H6zm3.5 6l8.5 6V6z"/></svg>
                        </button>

                        <button id="play-pause-btn" class="w-20 h-20 bg-white text-black rounded-full flex items-center justify-center hover:scale-105 active:scale-95 transition-all duration-300 shadow-[0_0_30px_rgba(255,255,255,0.15)]">
                            <svg id="play-icon" class="w-8 h-8 ml-1" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
                            <svg id="pause-icon" class="w-8 h-8 hidden" fill="currentColor" viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>
                        </button>

                        <button id="next-btn" class="text-gray-400 hover:text-white transition-colors">
                            <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 24 24"><path d="M6 18l8.5-6L6 6v12zM16 6v12h2V6h-2z"/></svg>
                        </button>

                        <a id="download-btn" href="#" download class="text-gray-500 hover:text-white transition-colors">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                        </a>
                    </div>

                    <div class="flex items-center gap-3 w-full max-w-[200px] mx-auto md:mx-0 opacity-70 hover:opacity-100 transition-opacity">
                        <svg class="w-4 h-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"></path></svg>
                        <input id="volume-slider" type="range" min="0" max="1" step="0.01" value="0.75" class="w-full">
                    </div>

                </div>
            </div>
        </div>
    </div>

    <audio id="audio-player" class="hidden"></audio>

    <script>
        const API_SEARCH = 'https://etzy-api.vercel.app/search/youtube?q=';
        const API_PLAY = 'https://etzy-api.vercel.app/downloader/ytplay?q=';

        const els = {
            searchToggle: document.getElementById('search-toggle-btn'),
            searchContainer: document.getElementById('search-container'),
            searchForm: document.getElementById('search-form'),
            searchInput: document.getElementById('search-input'),
            contentArea: document.getElementById('content-area'),
            greeting: document.getElementById('greeting-container'),
            resultsArea: document.getElementById('results-area'),
            msgArea: document.getElementById('message-area'),

            // Tabs
            tabSearch: document.getElementById('tab-search'),
            tabLibrary: document.getElementById('tab-library'),
            libraryArea: document.getElementById('library-area'),
            libraryList: document.getElementById('library-list'),
            emptyLibraryMsg: document.getElementById('empty-library-msg'),
            libraryCount: document.getElementById('library-count'),

            // Full Player
            playerOverlay: document.getElementById('player-overlay'),
            closePlayerBtn: document.getElementById('close-player-btn'),
            pCover: document.getElementById('player-cover'),
            pBg: document.getElementById('player-bg-image'),
            pTitle: document.getElementById('player-title'),
            pArtist: document.getElementById('player-artist'),
            marqueeWrapper: document.getElementById('marquee-wrapper'),
            fullLikeBtn: document.getElementById('full-like-btn'),

            // Mini Player
            miniPlayer: document.getElementById('mini-player'),
            miniCover: document.getElementById('mini-cover'),
            miniTitle: document.getElementById('mini-title'),
            miniArtist: document.getElementById('mini-artist'),
            miniPlayBtn: document.getElementById('mini-play-btn'),
            miniPlayIcon: document.getElementById('mini-play-icon'),
            miniPauseIcon: document.getElementById('mini-pause-icon'),
            miniLikeBtn: document.getElementById('mini-like-btn'),

            // Audio Controls
            audio: document.getElementById('audio-player'),
            playBtn: document.getElementById('play-pause-btn'),
            playIcon: document.getElementById('play-icon'),
            pauseIcon: document.getElementById('pause-icon'),
            nextBtn: document.getElementById('next-btn'),
            prevBtn: document.getElementById('prev-btn'),
            loopBtn: document.getElementById('loop-btn'),
            loopDot: document.getElementById('loop-dot'),
            dlBtn: document.getElementById('download-btn'),

            progCont: document.getElementById('progress-container'),
            progFill: document.getElementById('progress-fill'),
            currTime: document.getElementById('current-time'),
            durTime: document.getElementById('duration'),
            volSlider: document.getElementById('volume-slider')
        };

        // --- GLOBAL VARIABLES ---
        let playlist = []; // Playlist aktif
        let searchResults = []; // Cache hasil pencarian
        let favorites = JSON.parse(localStorage.getItem('ztune_likes')) || [];
        let currentSongIndex = -1;
        let isSearchVisible = false;
        let currentContext = 'search'; // 'search' atau 'library'

        // --- 1. TAB & DISPLAY LOGIC ---
        function switchTab(tab) {
            currentContext = tab;
            
            if (tab === 'search') {
                els.tabSearch.className = "px-4 py-1.5 text-xs font-bold rounded-full bg-white text-black transition-all shadow-lg";
                els.tabLibrary.className = "px-4 py-1.5 text-xs font-bold rounded-full text-gray-400 hover:text-white transition-all";
                
                els.libraryArea.classList.add('hidden');
                
                // Logic perbaikan: hanya tampilkan greeting jika hasil search kosong
                if (searchResults.length > 0) {
                    els.resultsArea.classList.remove('hidden');
                    els.greeting.classList.add('hidden');
                } else {
                    els.resultsArea.classList.add('hidden');
                    // Jika sedang mengetik/search terbuka, greeting sembunyi. Jika tidak, tampil.
                    if(!isSearchVisible) els.greeting.classList.remove('hidden');
                }
            } else {
                els.tabLibrary.className = "px-4 py-1.5 text-xs font-bold rounded-full bg-white text-black transition-all shadow-lg";
                els.tabSearch.className = "px-4 py-1.5 text-xs font-bold rounded-full text-gray-400 hover:text-white transition-all";
                
                els.greeting.classList.add('hidden');
                els.resultsArea.classList.add('hidden');
                els.libraryArea.classList.remove('hidden');
                
                renderLibrary();
            }
            if(isSearchVisible && tab === 'library') {
                els.searchToggle.click();
            }
        }

        els.tabSearch.onclick = () => switchTab('search');
        els.tabLibrary.onclick = () => switchTab('library');

        // --- 2. SEARCH LOGIC ---
        els.searchToggle.addEventListener('click', () => {
            isSearchVisible = !isSearchVisible;
            if (isSearchVisible) {
                switchTab('search');
                els.searchContainer.classList.remove('hidden');
                els.searchInput.focus();
                els.greeting.classList.add('hidden'); 
            } else {
                els.searchContainer.classList.add('hidden');
                if (searchResults.length === 0) els.greeting.classList.remove('hidden');
                else els.resultsArea.classList.remove('hidden');
            }
        });

        els.searchForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const q = els.searchInput.value.trim();
            if(!q) return;

            showMsg('Searching...', false);
            // Paksa sembunyi semua elemen saat loading agar tidak tumpang tindih
            els.resultsArea.classList.add('hidden');
            els.greeting.classList.add('hidden');
            els.libraryArea.classList.add('hidden');
            
            // Set context ke search tanpa mentrigger logika kosong
            currentContext = 'search';

            try {
                const res = await fetch(API_SEARCH + encodeURIComponent(q));
                const data = await res.json();

                if(data.status && data.result && data.result.length > 0) {
                    const valid = data.result.filter(i => i.title && i.link).slice(0, 20);
                    searchResults = valid; 
                    playlist = valid; 
                    displayResults(valid);
                } else {
                    showMsg('No results found.', true);
                    els.greeting.classList.remove('hidden');
                }
            } catch (err) {
                showMsg('Connection error.', true);
                els.greeting.classList.remove('hidden');
            }
        });

        function displayResults(items) {
            showMsg('', false);
            // Perbaikan Bug 1 & 3: Reset tampilan secara eksplisit
            els.greeting.classList.add('hidden');
            els.libraryArea.classList.add('hidden');
            els.resultsArea.classList.remove('hidden');
            els.resultsArea.innerHTML = '';
            
            // Pastikan tab style benar
            els.tabSearch.className = "px-4 py-1.5 text-xs font-bold rounded-full bg-white text-black transition-all shadow-lg";
            els.tabLibrary.className = "px-4 py-1.5 text-xs font-bold rounded-full text-gray-400 hover:text-white transition-all";

            items.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = 'bg-surface hover:bg-surfaceHighlight border border-white/5 p-3 rounded-2xl flex items-center gap-3 cursor-pointer transition-all hover:scale-[1.02] group';
                div.innerHTML = `
                    <div class="relative w-12 h-12 shrink-0 rounded-lg overflow-hidden bg-gray-800">
                        <img src="${item.imageUrl}" class="w-full h-full object-cover group-hover:opacity-80 transition-opacity">
                    </div>
                    <div class="flex-1 min-w-0">
                        <h3 class="text-xs md:text-sm font-bold text-white truncate group-hover:text-primary-500 transition-colors">${item.title}</h3>
                        <p class="text-[10px] md:text-xs text-gray-500 truncate">${item.channel || 'Artist'}</p>
                    </div>
                `;
                div.onclick = () => playSong(item, index, 'search');
                els.resultsArea.appendChild(div);
            });
        }

        // --- 3. LIBRARY LOGIC (LIKED SONGS) ---
        function toggleLike(song) {
            if (!song) return;
            
            // Cek apakah sudah ada
            const idx = favorites.findIndex(f => f.link === song.link);
            
            if (idx === -1) {
                favorites.push(song);
            } else {
                favorites.splice(idx, 1);
            }
            
            // Simpan ke LocalStorage
            localStorage.setItem('ztune_likes', JSON.stringify(favorites));
            
            // Update tombol Like di player saat ini
            updateLikeButtonState(song);
            
            // Jika kita sedang di tab library, refresh list agar sesuai
            if (currentContext === 'library') {
                renderLibrary();
            }
        }

        function updateLikeButtonState(song) {
            if(!song) return;
            // Gunakan .some() untuk pengecekan yang akurat
            const isLiked = favorites.some(f => f.link === song.link);
            
            const colorClass = isLiked ? 'text-red-500 scale-110' : 'text-gray-400 hover:text-white';
            
            els.fullLikeBtn.className = `p-2 rounded-full transition-all ${colorClass}`;
            els.miniLikeBtn.className = `transition-all focus:outline-none ${colorClass}`;
        }

        function renderLibrary() {
            els.libraryList.innerHTML = '';
            els.libraryCount.textContent = `${favorites.length} songs`;

            if (favorites.length === 0) {
                els.emptyLibraryMsg.classList.remove('hidden');
                return;
            }
            els.emptyLibraryMsg.classList.add('hidden');

            favorites.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = 'bg-surface hover:bg-surfaceHighlight border border-white/5 p-3 rounded-2xl flex items-center gap-3 cursor-pointer transition-all hover:scale-[1.02] group';
                div.innerHTML = `
                    <div class="relative w-12 h-12 shrink-0 rounded-lg overflow-hidden bg-gray-800">
                        <img src="${item.imageUrl}" class="w-full h-full object-cover group-hover:opacity-80 transition-opacity">
                    </div>
                    <div class="flex-1 min-w-0">
                        <h3 class="text-xs md:text-sm font-bold text-white truncate group-hover:text-primary-500 transition-colors">${item.title}</h3>
                        <p class="text-[10px] md:text-xs text-gray-500 truncate">${item.channel || 'Artist'}</p>
                    </div>
                `;
                div.onclick = () => playSong(item, index, 'library');
                els.libraryList.appendChild(div);
            });
        }

        // --- 4. PLAYER LOGIC ---
        async function playSong(item, index, context) {
            // Perbaikan Bug 2: 
            // Saat memutar dari Library, kita buat COPY dari favorites ([...favorites]).
            // Ini mencegah error "tidak bisa like kembali" (index bergeser) saat kita unlike lagu yang sedang diputar.
            if (context === 'library') {
                playlist = [...favorites];
            } else {
                playlist = searchResults;
            }
            currentContext = context;
            currentSongIndex = index;

            openPlayerOverlay();
            
            els.pTitle.textContent = item.title;
            els.pArtist.textContent = item.channel || 'Loading...';
            els.pCover.src = item.imageUrl;
            els.pBg.src = item.imageUrl;
            els.miniTitle.textContent = item.title;
            els.miniArtist.textContent = item.channel;
            els.miniCover.src = item.imageUrl;

            checkMarquee(item.title);
            updateLikeButtonState(item); // Update status tombol

            try {
                const res = await fetch(API_PLAY + encodeURIComponent(item.link));
                const data = await res.json();

                if(data.success && data.result?.downloadUrl) {
                    const m = data.result.metadata;
                    els.pTitle.textContent = m.title || item.title;
                    checkMarquee(els.pTitle.textContent);

                    els.dlBtn.href = data.result.downloadUrl;
                    els.audio.src = data.result.downloadUrl;
                    els.audio.volume = els.volSlider.value;

                    playAudio();
                } else {
                    console.error("Stream failed");
                }
            } catch (e) {
                console.error(e);
            }
        }

        // --- 5. AUDIO & NAVIGATION ---
        function playAudio() {
            els.audio.play().then(() => {
                updatePlayIcons(true);
            }).catch(e => console.log("Auto-play blocked"));
        }

        function pauseAudio() {
            els.audio.pause();
            updatePlayIcons(false);
        }

        function updatePlayIcons(isPlaying) {
            if(isPlaying) {
                els.playIcon.classList.add('hidden');
                els.pauseIcon.classList.remove('hidden');
                els.miniPlayIcon.classList.add('hidden');
                els.miniPauseIcon.classList.remove('hidden');
                els.miniCover.parentElement.classList.remove('paused-spin');
            } else {
                els.playIcon.classList.remove('hidden');
                els.pauseIcon.classList.add('hidden');
                els.miniPlayIcon.classList.remove('hidden');
                els.miniPauseIcon.classList.add('hidden');
                els.miniCover.parentElement.classList.add('paused-spin');
            }
        }

        els.playBtn.onclick = () => els.audio.paused ? playAudio() : pauseAudio();
        els.miniPlayBtn.onclick = (e) => {
            e.stopPropagation();
            els.audio.paused ? playAudio() : pauseAudio();
        };

        const handleLikeClick = (e) => {
            e.stopPropagation();
            // Ambil lagu yang sedang diputar berdasarkan playlist yang aktif
            if (currentSongIndex !== -1 && playlist[currentSongIndex]) {
                toggleLike(playlist[currentSongIndex]);
            }
        };
        els.fullLikeBtn.onclick = handleLikeClick;
        els.miniLikeBtn.onclick = handleLikeClick;

        els.audio.onended = () => {
            if (els.audio.loop) {
                playAudio();
            } else {
                playNextSong();
            }
        };

        function playNextSong() {
            if (currentSongIndex < playlist.length - 1) {
                playSong(playlist[currentSongIndex + 1], currentSongIndex + 1, currentContext);
            } else {
                updatePlayIcons(false);
            }
        }

        els.nextBtn.onclick = playNextSong;
        els.prevBtn.onclick = () => {
            if(currentSongIndex > 0) playSong(playlist[currentSongIndex - 1], currentSongIndex - 1, currentContext);
            else els.audio.currentTime = 0;
        };

        function openPlayerOverlay() {
            els.playerOverlay.classList.remove('hidden');
            els.playerOverlay.classList.add('flex');
            els.miniPlayer.classList.add('translate-y-[150%]'); 
            els.miniPlayer.classList.add('hidden');
            document.body.style.overflow = 'hidden'; 
        }

        function closePlayerOverlay() {
            els.playerOverlay.classList.add('hidden');
            els.playerOverlay.classList.remove('flex');
            document.body.style.overflow = 'auto';

            if(els.audio.src) {
                els.miniPlayer.classList.remove('hidden');
                setTimeout(() => {
                    els.miniPlayer.classList.remove('translate-y-[150%]');
                }, 10);
            }
        }

        els.closePlayerBtn.onclick = closePlayerOverlay;
        els.miniPlayer.onclick = (e) => {
            if(!e.target.closest('button')) openPlayerOverlay();
        };

        function checkMarquee(text) {
            els.pTitle.classList.remove('animate-scroll');
            setTimeout(() => {
                const containerWidth = els.marqueeWrapper.clientWidth;
                const textWidth = els.pTitle.scrollWidth;
                if (textWidth > containerWidth) {
                    els.pTitle.classList.add('animate-scroll');
                }
            }, 100);
        }

        els.loopBtn.onclick = () => {
            els.audio.loop = !els.audio.loop;
            els.loopDot.classList.toggle('hidden', !els.audio.loop);
            els.loopBtn.classList.toggle('text-white', els.audio.loop);
        };

        els.volSlider.oninput = (e) => els.audio.volume = e.target.value;

        els.audio.ontimeupdate = () => {
            const curr = els.audio.currentTime;
            const dur = els.audio.duration;
            if(dur) {
                const pct = (curr / dur) * 100;
                els.progFill.style.width = pct + '%';
                els.currTime.textContent = fmtTime(curr);
                els.durTime.textContent = fmtTime(dur);
            }
        };

        els.progCont.onclick = (e) => {
            const rect = els.progCont.getBoundingClientRect();
            const dur = els.audio.duration;
            if(dur) els.audio.currentTime = ((e.clientX - rect.left) / rect.width) * dur;
        };

        function fmtTime(s) {
            if(isNaN(s)) return "0:00";
            const m = Math.floor(s / 60);
            const sec = Math.floor(s % 60);
            return `${m}:${sec < 10 ? '0' : ''}${sec}`;
        }

        function showMsg(text, isError) {
            els.msgArea.textContent = text;
            els.msgArea.className = `text-center text-sm font-medium py-4 transition-all ${isError ? 'text-red-500' : 'text-gray-400'} ${text ? '' : 'hidden'}`;
        }

        function setGreeting() {
            const h = new Date().getHours();
            let t = 'Music Awaits.';
            if(h < 12) t = 'Good Morning.';
            else if(h < 18) t = 'Good Afternoon.';
            else t = 'Good Evening.';
            document.getElementById('greeting-text').textContent = t;
        }
        setGreeting();
    </script>
</body>
</html>
